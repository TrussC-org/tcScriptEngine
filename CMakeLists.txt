cmake_minimum_required(VERSION 3.20)

# TRUSSC_DIR is provided by CMakePresets.json (generated by projectGenerator)
# For CI/manual builds without presets, fallback to relative path
if(NOT DEFINED TRUSSC_DIR)
    set(TRUSSC_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../../../trussc")
endif()

include(${TRUSSC_DIR}/cmake/trussc_app.cmake)

trussc_app()

# ============================================================================
# AngelScript
# ============================================================================
include(FetchContent)

FetchContent_Declare(
    angelscript
    GIT_REPOSITORY https://github.com/anjo76/angelscript.git
    GIT_TAG        master
    GIT_SHALLOW    TRUE
)

FetchContent_MakeAvailable(angelscript)

# AngelScript CMake is in sdk/angelscript/projects/cmake
add_subdirectory(${angelscript_SOURCE_DIR}/sdk/angelscript/projects/cmake angelscript_build)

target_include_directories(${PROJECT_NAME} PRIVATE
    ${angelscript_SOURCE_DIR}/sdk/angelscript/include
    ${angelscript_SOURCE_DIR}/sdk/add_on
)
target_link_libraries(${PROJECT_NAME} PRIVATE angelscript)

# Add AngelScript add-ons (scriptstdstring for std::string, scriptarray for arrays)
target_sources(${PROJECT_NAME} PRIVATE
    ${angelscript_SOURCE_DIR}/sdk/add_on/scriptstdstring/scriptstdstring.cpp
    ${angelscript_SOURCE_DIR}/sdk/add_on/scriptarray/scriptarray.cpp
)

# ============================================================================
# Emscripten settings
# ============================================================================
if(EMSCRIPTEN)
    # Export functions for JS interop
    target_link_options(${PROJECT_NAME} PRIVATE
        -sEXPORTED_FUNCTIONS=['_main','_updateScriptCode','_getScriptError','_clearScriptFiles','_addScriptFile','_buildScriptFiles','_pauseEngine','_resumeEngine']
        -sEXPORTED_RUNTIME_METHODS=['ccall','cwrap']
    )
endif()
